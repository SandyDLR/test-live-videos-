<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Localized video with subtitles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; }
    video { width: 100%; max-width: 800px; border-radius: 12px; display: block; margin-bottom: 1rem; }
    button { padding: .7rem 1rem; font-size: 1rem; border-radius: 8px; cursor: pointer; }
    .hidden { display: none; }
  </style>

  <!-- Transifex Live snippet (replace YOUR_TOKEN below) -->
  <script>
    window.liveSettings = { api_key: "YOUR_TOKEN" };
    (function(d){
      var s=d.createElement('script'); s.async=true;
      s.src='https://cdn.transifex.com/live.js';
      d.head.appendChild(s);
    })(document);
  </script>
</head>
<body>
  <h1>Localized video demo (local files)</h1>

  <!-- Translatable URLs -->
  <div class="hidden" aria-hidden="true">
    <span id="tx-video-url">video.mp4</span>
    <span id="tx-subs-url">subs/en.srt</span>
  </div>

  <video id="player" controls preload="metadata" crossorigin="anonymous">
    <track id="subTrack" kind="subtitles" label="Subtitles" default />
    Your browser does not support HTML5 video.
  </video>

  <button id="playBtn">Play video</button>

  <script>
    const player = document.getElementById('player');
    const trackEl = document.getElementById('subTrack');
    const playBtn = document.getElementById('playBtn');

    function getLocalizedURLs() {
      const videoUrl = document.getElementById('tx-video-url').textContent.trim();
      const subsUrl  = document.getElementById('tx-subs-url').textContent.trim();
      return { videoUrl, subsUrl };
    }

    function srtToVtt(srtText) {
      const vttBody = srtText
        .replace(/\r+/g, '')
        .replace(/^\s*$/gm, '')
        .replace(/(\d+)\s*\n(\d{2}:\d{2}:\d{2}),(\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2}),(\d{3})/g,
                 (m, idx, h1, ms1, h2, ms2) => `${idx}\n${h1}.${ms1} --> ${h2}.${ms2}`);
      return 'WEBVTT\n\n' + vttBody;
    }

    async function loadCaptions(src) {
      if (src.toLowerCase().endsWith('.vtt')) {
        trackEl.src = src;
        return;
      }
      if (src.toLowerCase().endsWith('.srt')) {
        const res = await fetch(src);
        const srt = await res.text();
        const vtt = srtToVtt(srt);
        const blob = new Blob([vtt], { type: 'text/vtt' });
        const url = URL.createObjectURL(blob);
        trackEl.src = url;
        return;
      }
      trackEl.src = src;
    }

    async function setMediaFromTranslatedStrings() {
      const { videoUrl, subsUrl } = getLocalizedURLs();
      player.src = videoUrl;
      await loadCaptions(subsUrl);
      trackEl.srclang = (document.documentElement.lang || 'en').split('-')[0];
    }

    playBtn.addEventListener('click', async () => {
      await setMediaFromTranslatedStrings();
      await player.play();
    });

    window.addEventListener('DOMContentLoaded', async () => {
      await setMediaFromTranslatedStrings();
    });
  </script>

  <h2>How to localize</h2>
  <ol>
    <li>Run a local server and open the page with Transifex Live active.</li>
    <li>Translate the two hidden strings:
      <ul>
        <li><strong>video.mp4</strong> → your localized video if needed (e.g., <code>subs/es/video.mp4</code>)</li>
        <li><strong>subs/en.srt</strong> → <code>subs/es.srt</code> or <code>subs/pt.srt</code></li>
      </ul>
    </li>
    <li>When you switch language, the new URLs will load automatically.</li>
  </ol>
</body>
</html>
